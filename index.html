
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>赵成辉的博客</title>
  <meta name="author" content="赵成辉">

  
  <meta name="description" content="Octopress 搭建流程 1.为什么是 Octopress &amp; Github Pages? 在做任何事情之前最好先问个为什么，尽管很多情况下未必有答案，但这个做法绝对有好处。用 Octopress 搭建博客，并托管到 Github Pages，撇除一些个人因素之外，我想还有以下几点原因 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://feiji1hao.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="赵成辉的博客" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">赵成辉的博客</a></h1>
  
    <h2>A blogging framework for iOS.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="feiji1hao.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/14/octopressda-jian-jiao-cheng/">Octopress搭建教程</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-14T12:06:49+08:00'><span class='date'>2015 年5 月14 日</span> <span class='time'>12:06 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Octopress 搭建流程</h1>

<h2>1.为什么是 Octopress &amp; Github Pages?</h2>

<p>在做任何事情之前最好先问个为什么，尽管很多情况下未必有答案，但这个做法绝对有好处。用 Octopress 搭建博客，并托管到 Github Pages，撇除一些个人因素之外，我想还有以下几点原因：
免费且独立。把 Octopress 博客系统搭建到 Github Pages 虽是免费，但不失独立性，即便 Github 全站关闭，你也将有一份本地全站备份，随时可以重新恢复。不必受托管商之气，而且还免费，如果你愿意，甚至可以自行插入广告挣钱。</p>

<p>版本控制。写文章，建网站，做软件都需要修改，但有时候改完了又会后悔，如果有时光机就好了，Git 就是你的时光机。当然如果你不想了解这些看上去很唬人的 IT 名词，只是想写博客的话，请在需要的时候再研究这条的内容。</p>

<p>相对其他托管到 Github 上的博客程序，Octopress 更加成熟易上手。打个比方，Jekyll 可以说是毛坯房，Hexo 和 Octopress 算是简装修，但相比 Hexo，Octopress 有更多装修范例和更多熟练的装修工人，更容易获取帮助。当然如果你只想住精装修的房子，那不得不花点钱上 WordPress 了。</p>

<p>使用 Markdown。Markdown 是现在最为流行的轻量级标记语言，也是已故的天才 Aaron Swartz 留给世人最好的礼物，窃以为每个在互联网上发布文章的人都该掌握。</p>

<p>按照官方的说法，Octopress 是个「为黑客设计的博客框架」，这很酷，你不觉得吗？</p>

<p>如果你之前没有写过博客，打算开始搭建自己第一个博客的话，其实也不妨试试 Octopress，免费还能学到东西，何乐而不为？</p>

<h2>2. 准备工作</h2>

<p>既然是为黑客设计的博客框架，安装起来肯定没有像普通应用程序那么简单，需要一些准备工作，但请相信我，并不复杂。</p>

<h3>2.1 安装 git</h3>

<p>既然要使用 Github，那么肯定首先要安装 Git</p>

<h3>2.2 安装 Ruby</h3>

<p>先说句题外话，其实我是从 Ruby 语言才知道有诞生石这种说法的。安装 Ruby 稍稍有些复杂，不过你只要按照以下步骤一步一步来就好了：</p>

<p>安装 HomeBrew
HomeBrew 是一个非常有用的软件包管理系统，你可以把它想象成一个稍微抽象一点的 Mac App Store. 正如我们用 Mac App Store 来安装其他软件一样，我们这一步安装 HomeBrew 的目的是为了安装别的软件 (Ruby) 。当然 Mac App Store 和 HomeBrew 本身也是软件。</p>

<p>安装 HomeBrew 非常简单，打开终端 (Terminal)，执行以下命令（所谓「执行」即「输入+回车」，下同）：</p>

<p><code>ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"</code></p>

<p>如果在执行上如命令的时候弹出需要安装 Xcode Command Line Tool 的提示，直接点击安装即可。</p>

<p>安装好之后最好先执行以下命令：</p>

<p><code>brew doctor</code></p>

<p>此条命令用来诊断安装中出现的问题并提示修复方法，如果没有问题则会显示：</p>

<p>Your system is ready to brew.
如遇问题，则按照提示处理，如果不懂如何处理可以先试着执行后面的步骤，如果能成功，则没有太大问题，毕竟我们只是想写博客而已。当然，做任何事情之前，备份是必须的。</p>

<p>使用 RVM 安装 Ruby
执行以下命令安装 RVM，最新的稳定版 Ruby 也会随之安装：</p>

<p><code>curl -L https://get.rvm.io | bash -s stable --ruby</code></p>

<p>为避免出现问题，可执行以下命令安装 Ruby 2.0.0:</p>

<p><code>rvm install 2.0.0</code></p>

<p><code>rvm use 2.0.0</code></p>

<p><code>rvm rubygems latest</code></p>

<p>可以执行 <code>ruby --version</code> 命令来查看现在使用的 Ruby 版本，确保正在使用的是 Ruby 2.0.0</p>

<h3>2.3 注册 Github 账号</h3>

<p>这个没什么好说的，早晚需要，去 <a href="http://github.com">http://github.com</a> 注册吧。</p>

<h3>2.4 域名指向（可选）</h3>

<p>如果你有自己的域名可用，可以在这时就配置好，毕竟解析起来需要一段时间，不如在我们搭建博客的时候让它开始，这样我们搭建完成后，基本上就可以直接用自有域名访问了。</p>

<p>如果你用的是顶级域名，比如 shengmingzhiqing.com, 请创建两个 A 记录 (A Record) 分别指向 192.30.252.153 和 192.30.252.154.</p>

<p>如果你使用二级域名，比如 blog.shengmingzhiqing.com, 请将该域名的 CNAME 指向 [your_username].github.io, 把其中的 [your_username]换成你自己在 Github 上的用户名。</p>

<p>如果你暂时没有域名，这一步可以暂时不用管。</p>

<h2>3. 本地安装 Octopress</h2>

<p>终于进入正题了。有了前面的准备工作，安装 Octopress 显得非常简单：</p>

<p>首先，打开终端 (Terminal) 执行如下命令：</p>

<p><code>git clone git://github.com/imathis/octopress.git octopress</code></p>

<p><code>cd octopress</code></p>

<p>上面的代码中，第一行的作用是把 Octopress 克隆到本地磁盘，将会在你的本地~/user/yourusername 这个文件夹下生成一个名为 octopress 的文件夹。如果你不知道 yourusername 是什么，其实就是你每次打开终端时，$ 这个符号前面显示的那玩意。</p>

<p>第二行的作用是进入这个新建的 octopress 文件夹。这一步可能会碰到一个「是否要信任 .rvmrc file」的问题，输入 yes.</p>

<p>然后我们开始安装 Octopress 所必需的依赖项(dependencies)，执行以下命令：</p>

<p><code>gem install bundler</code></p>

<p><code>bundle install</code></p>

<p>然后执行如下命令安装默认主题：</p>

<p><code>rake install</code></p>

<p>本地安装完毕。顺便说一句，所谓 rake 就是 ruby make 的缩写。</p>

<p>这时你执行如下命令：</p>

<p><code>rake preview</code></p>

<p>然后在浏览器内输入 <a href="http://localhost:4000/%EF%BC%8C%E5%8D%B3%E5%8F%AF%E7%9C%8B%E5%88%B0%E6%88%91%E4%BB%AC%E6%90%AD%E5%BB%BA%E5%AE%8C%E6%88%90%E7%9A%84%E5%8D%9A%E5%AE%A2%E3%80%82%E4%B9%9F%E8%AE%B8%E5%B9%B6%E4%B8%8D%E5%A5%BD%E7%9C%8B%EF%BC%8C%E4%BD%86%E5%BE%88%E4%BB%A4%E4%BA%BA%E5%BC%80%E5%BF%83%EF%BC%8C%E4%B8%8D%E6%98%AF%E4%B9%88%EF%BC%9F">http://localhost:4000/%EF%BC%8C%E5%8D%B3%E5%8F%AF%E7%9C%8B%E5%88%B0%E6%88%91%E4%BB%AC%E6%90%AD%E5%BB%BA%E5%AE%8C%E6%88%90%E7%9A%84%E5%8D%9A%E5%AE%A2%E3%80%82%E4%B9%9F%E8%AE%B8%E5%B9%B6%E4%B8%8D%E5%A5%BD%E7%9C%8B%EF%BC%8C%E4%BD%86%E5%BE%88%E4%BB%A4%E4%BA%BA%E5%BC%80%E5%BF%83%EF%BC%8C%E4%B8%8D%E6%98%AF%E4%B9%88%EF%BC%9F</a></p>

<p>注意，以上各步中如果出现权限问题（关键词 permission），无法完成（关键词 abort）的话，请在各命令前加上 sudo+空格，如有提示，请输入电脑登录密码。</p>

<h2>4. 将 Octopress 部署到 Github Pages</h2>

<h3>4.1 新建库 (Repository)</h3>

<p>用刚刚注册的 Github 账号登录，然后在点击页面右上角的加号，在弹出菜单中点击 New Repository</p>

<p>然后会跳转到一个新建库 (Create new repository) 的页面，在Repository name一栏填 [your_username].github.io，[your_username] 是你 Github 上的用户名，请务必按照此格式填写，否则无法在 Github 上部署博客。然后点击 Create repository 按钮提交。</p>

<p>如果一切顺利会出现一个页面，有一个 SSH 地址，形如 git@github.com:[your_username]/[your_username].github.io.git，下一步会用到。</p>

<h3>4.2 将本地部署的 Octopress 发布到 Github Pages</h3>

<p>打开终端 (Terminal)，执行以下命令：</p>

<p><code>cd octopress</code></p>

<p><code>rake setup_github_pages</code></p>

<p>然后会出现一个问句，请把 4.1 步生成的 SSH 地址粘贴到这里，然后回车继续。</p>

<p>执行以下命令：
rake generate
rake deploy
第一行命令用来生成页面，第二行命令用来部署页面，可按照字面意思理解。如果理解不了，可以暂且不管。任何一步如果出现失败提示，请使用 sudo。</p>

<p>如果上述内容完成，即可使用 <a href="http://">http://</a>[your_username].github.io/ 访问页面，将会出现一个和在本地预览时相同的页面。</p>

<p>然后，不要忘了把源文件全部发布到 source 分支下面，再一次可以看不懂，执行以下命令：</p>

<p><code>git add .</code></p>

<p><code>git commit -m "备注内容"</code></p>

<p><code>git push origin source</code></p>

<h3>4.3 使用自己的域名（可选）</h3>

<p>如果你有自己的域名，并且想指向这个新博客的话，请首先确保执行了 2.4 节中的内容。如果没有执行，可以随时执行。</p>

<p>然后执行下面的命令，注意把 your-domain.com 换成你自己的域名。</p>

<p><code>echo 'your-domain.com' &gt;&gt; source/CNAME</code></p>

<p>然后再次执行以下命令：</p>

<p><code>rake generate</code></p>

<p><code>rake deploy</code></p>

<p>这样你就可以使用自己的域名了。域名解析需要一段时间，如果没有马上生效，请不要着急。如果长时间没有生效，请确保完整执行了 2.4 节和本节内容。</p>

<h2>5. 发布新贴</h2>

<p>博客搭建好了，我们可以开始我们的第一贴了。那么怎么发布新贴呢？如果你真的想像个黑客一样写博客，我们可以继续使用我们的终端 (Terminal) 和命令行，执行以下命令：</p>

<p><code>cd octopress</code></p>

<p><code>rake new_post["Post Title"]</code></p>

<p>把其中的 Post Title 替换为你想写的文章标题。然后会有一个名为 yyyy-mm-dd-Post-Title.markdown 的文件在 octopress/source/_posts 目录下生成，其中 yyyy-mm-dd 是你当时的日期。然后执行以下命令：</p>

<p><code>cd source/_posts/</code></p>

<p><code>vim yyyy-mm-dd-Post-Title.markdown</code></p>

<p>即可用 vim 编辑器编辑的刚才的文章了，好吧我知道你作为这篇文章的读者并不是一个能熟练使用 vim 的人，那么请在命令行输入 :q退出这个编辑器。如果你不想假装是个黑客的话，其实发布文章并不需要这么麻烦。</p>

<p>我们直接打开 octopress/source/_posts 文件夹，找到刚才生成的文件，用你喜欢的 Markdown 编辑器（免费的我推荐 Mou，收费的我推荐 Byword）或者文本编辑器打开，对文章内容进行编辑。</p>

<p>打开文件后，你会发现文章开头有这么一段信息:</p>

<p>layout: post<br/>
title: &ldquo;Post Title&rdquo;<br/>
date: yyyy-mm-dd hh:mm:ss<br/>
comments: true<br/>
categories: &ldquo;&rdquo;</p>

<p>这其实是这篇文章的元数据：layout 暂时不要理会；title 是这篇文章显示在最终网页上的标题；date 部分是详细的文件生成时间，如 2014-04-28 03:35:00；comment 部分表示是否允许评论，目前显示是允许，如果想关闭评论，请改为 false；categories 指这篇文章的分类目录，请在后面引号中输入，如果没有该目录，则会自动生成。请不要删除这段信息，在这段信息下面开始你的文章内容。</p>

<p>这件事情给我们的启发是，以后发布文章，其实并不需要使用终端命令行生成文件。可以直接将自己写好的文章放到这个文件夹下面，当然请按照 yyyy-mm-dd-Post-Title.markdown 这样的文件格式命名，同时记得在文章前面添加元数据信息。这种做法生成的文章与上面的方法无异。如果你觉得添加元数据信息过于麻烦，推荐一个非常好用的工具：TextExpander。</p>

<p>在文章写好之后，使用命令行执行（仔细观察命令，像不像 generate 和 deploy 的合体？）：</p>

<p><code>rake gen_deploy</code></p>

<p>同样，如果在本节中，任何命令执行失败，没有取得想要结果，请在前面加 sudo。是时候说一说 sudo 命令了，这其实是 super do 的缩写，之所以用它是因为，一般而言 Mac 上最高权限的root 账户默认是关闭的。我们自己的账户哪怕是管理员也在一些地方没有权限操作，super do 其实就是越权操作的意思，因此也往往需要输入密码，一般而言短时间内不需要输入第二次。</p>

<p>这样你的第一篇日志就发布出来了，恭喜你正式开通了基于 Octopress 的独立博客。</p>

<p>当然你会发现似乎文章作者不是你，界面是英文显示，整体排版效果差强人意等等问题，不着急，我们会在接下来的文章中讲解如何配置和修改 Octopress 博客。</p>

<p>对于实用性知识，我的向来的态度是「精益学习」，先把最核心最当紧的问题解决了，其余问题发现一例解决一例，不断在干中学，不断版本迭代。后面讲到如何配置修改 Octopress 博客的文章就秉承这一原则，先将遇到了什么问题，然后将如何寻找解决方法。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/14/hello-octopress/">Hello Octopress</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-14T11:00:24+08:00'><span class='date'>2015 年5 月14 日</span> <span class='time'>11:00 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content">
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/03/kubernetes-services/">Kubernetes解析：services</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-03T00:00:00+08:00'><span class='date'>2014 年11 月3 日</span> <span class='time'>12:00 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Kubernetes从0.4开始，开发很快，变化也很大。这里谈谈services的一些变化。
之前的kubernetes services，kube-proxy在host上监听service指定的端口，然后由kube-proxy将请求转到后端具体的pods。这有一些问题：</p>

<p>（1）最大的问题，由于kube-proxy在host上监听端口，这样pod内的容器在expose时，就不能使用该host的该端口；而且service之间可能冲突；</p>

<p>（2）环境变量不能动态更新，所以pods不能知道在它之后启动的service的信息。</p>

<p>为此，kubernetes重新设计了services，让每个service都有一个自己的IP，但这并不是一个真正IP，而是通过iptables实现一个虚拟的IP。每个节点都生成这样一条类似的iptables规则：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>-A KUBE-PROXY -d <span class="k">${</span><span class="nv">service</span><span class="p">-ip</span><span class="k">}</span>/32 -p tcp -m comment --comment apache-service -m tcp --dport <span class="k">${</span><span class="nv">service</span><span class="p">-port</span><span class="k">}</span> -j REDIRECT --to-ports <span class="k">${</span><span class="nv">kube</span><span class="p">-proxy-port</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于kube-proxy-port是随机生成，大大减少了host port冲突的机会。另外，由于每个service都有一个自己的IP，所以service之间冲突也没有了，不同的service可以使用相同的port。</p>

<p>考虑3个节点：</p>

<p>yy1: 172.16.213.138 (master)</p>

<p>yy2: 172.16.213.140 (minion)</p>

<p>yy3: 172.16.213.141 (minion)</p>

<p>apiserver运行参数</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>＃kube-apiserver --logtostderr<span class="o">=</span><span class="nb">true</span> --v<span class="o">=</span><span class="m">0</span> --etcd_servers<span class="o">=</span>http://172.16.213.138:4001 --address<span class="o">=</span>0.0.0.0 --port<span class="o">=</span><span class="m">8080</span> --machines<span class="o">=</span>172.16.213.140,172.16.213.141 --minion_port<span class="o">=</span><span class="m">10250</span> --allow_privileged<span class="o">=</span><span class="nb">true</span> --portal_net<span class="o">=</span>10.11.0.0/16
</span></code></pre></td></tr></table></div></figure>


<p>定义services</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>cat apache-service.json
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;apache-service&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;kind&quot;</span>: <span class="s2">&quot;Service&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;apiVersion&quot;</span>: <span class="s2">&quot;v1beta1&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;port&quot;</span>: 12345,
</span><span class='line'>  <span class="s2">&quot;containerPort&quot;</span>: 80,
</span><span class='line'>  <span class="s2">&quot;selector&quot;</span>: <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;apache&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>port为services的端口，kubernetes会为该service选择一个portal_net子网内的一个IP。
如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>kubecfg -c apache-service.json create services
</span><span class='line'>ID                  Labels              Selector            IP                  Port
</span><span class='line'>----------          ----------          ----------          ----------          ----------
</span><span class='line'>apache-service                          <span class="nv">name</span><span class="o">=</span>apache         10.11.0.1           12345
</span></code></pre></td></tr></table></div></figure>


<p>可以看看yy2，yy3上iptables的变化。</p>

<p>yy2</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>yy@yy2 ~<span class="o">]</span><span class="nv">$ </span>sudo iptables -nvL -t nat
</span><span class='line'>Chain KUBE-PROXY <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
</span><span class='line'> pkts bytes target     prot opt in     out     <span class="nb">source               </span>destination
</span><span class='line'>    <span class="m">1</span>    <span class="m">60</span> REDIRECT   tcp  --  *      *       0.0.0.0/0            10.11.0.1            /* apache-service */ tcp dpt:12345 redir ports 33945
</span><span class='line'>
</span><span class='line'><span class="o">[</span>yy@yy2 ~<span class="o">]</span><span class="nv">$ </span>sudo netstat -ltnp<span class="p">|</span>grep 33945
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::33945                :::*                    LISTEN      247/kube-proxy
</span></code></pre></td></tr></table></div></figure>


<p>yy3</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>yy@yy3 ~<span class="o">]</span><span class="nv">$ </span>sudo iptables -nvL -t nat
</span><span class='line'>Chain KUBE-PROXY <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
</span><span class='line'> pkts bytes target     prot opt in     out     <span class="nb">source               </span>destination
</span><span class='line'><span class="m">0</span>     <span class="m">0</span> REDIRECT   tcp  --  *      *       0.0.0.0/0            10.11.0.1            /* apache-service */ tcp dpt:12345 redir ports 47163
</span><span class='line'>
</span><span class='line'><span class="o">[</span>yy@yy3 ~<span class="o">]</span><span class="nv">$ </span>sudo netstat -ltnp<span class="p">|</span>grep 47163
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::47163                :::*                    LISTEN      255/kube-proxy
</span></code></pre></td></tr></table></div></figure>


<p>整体结构大致如下：
<img src="/assets/2014-11-03-kubernetes-services.png" alt="" /></p>

<p>更多内容请参考
<a href="https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/services.md">https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/services.md</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/31/veth/">从veth看虚拟网络设备的qdisc</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-10-31T00:00:00+08:00'><span class='date'>2014 年10 月31 日</span> <span class='time'>12:00 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>背景</h2>

<p>前段时间在测试docker的网络性能的时候，发现了一个veth的性能问题，后来给docker官方提交了一个PR，参考<a href="https://github.com/docker/libcontainer/pull/193">set tx_queuelen to 0 when create veth device</a>，引起了一些讨论。再后来，RedHat的网络专家<a href="https://github.com/netoptimizer">Jesper Brouer</a> 出来详细的讨论了一下这个问题。</p>

<p><img src="http://images.cnitblog.com/blog/23202/201410/141941365298477.png" alt="veth qdisc" /></p>

<p>可以看到，veth设备qdisc队列，而环回设备/桥接设备是没qdisc队列的，参考br_dev_setup函数。</p>

<h2>内核实现</h2>

<p>在注册（创建）设备时，qdisc设置为noop_qdisc，
register_netdevice -> dev_init_scheduler</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">dev_init_scheduler</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">qdisc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">noop_qdisc</span><span class="p">;</span>
</span><span class='line'>  <span class="n">netdev_for_each_tx_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_init_scheduler_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">noop_qdisc</span><span class="p">);</span>
</span><span class='line'>  <span class="n">dev_init_scheduler_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">noop_qdisc</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">,</span> <span class="n">dev_watchdog</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>打开设备时，如果没有配置qdisc时，就指定为默认的pfifo_fast队列：
dev_open -> dev_activate，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">dev_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">need_watchdog</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* No queueing discipline is attached to device;</span>
</span><span class='line'><span class="cm">    create default one i.e. pfifo_fast for devices,</span>
</span><span class='line'><span class="cm">    which need queueing and noqueue_qdisc for</span>
</span><span class='line'><span class="cm">    virtual interfaces</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qdisc</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">noop_qdisc</span><span class="p">)</span>
</span><span class='line'>      <span class="n">attach_default_qdiscs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">attach_default_qdiscs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">qdisc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">txq</span> <span class="o">=</span> <span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_is_multiqueue</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">netdev_for_each_tx_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">attach_one_default_qdisc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">qdisc</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">qdisc_sleeping</span><span class="p">;</span>
</span><span class='line'>      <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qdisc</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="c1">///multi queue</span>
</span><span class='line'>      <span class="n">qdisc</span> <span class="o">=</span> <span class="n">qdisc_create_dflt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mq_qdisc_ops</span><span class="p">,</span> <span class="n">TC_H_ROOT</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">qdisc</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">qdisc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">attach</span><span class="p">(</span><span class="n">qdisc</span><span class="p">);</span>
</span><span class='line'>          <span class="n">dev</span><span class="o">-&gt;</span><span class="n">qdisc</span> <span class="o">=</span> <span class="n">qdisc</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">attach_one_default_qdisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
</span><span class='line'>                   <span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">dev_queue</span><span class="p">,</span>
</span><span class='line'>                   <span class="kt">void</span> <span class="o">*</span><span class="n">_unused</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">qdisc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">qdisc</span> <span class="o">=</span> <span class="n">qdisc_create_dflt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_queue</span><span class="p">,</span>
</span><span class='line'>                    <span class="o">&amp;</span><span class="n">pfifo_fast_ops</span><span class="p">,</span> <span class="n">TC_H_ROOT</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdisc</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: activation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/* Can by-pass the queue discipline for default qdisc */</span>
</span><span class='line'>      <span class="n">qdisc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TCQ_F_CAN_BYPASS</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">qdisc</span> <span class="o">=</span>  <span class="o">&amp;</span><span class="n">noqueue_qdisc</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">dev_queue</span><span class="o">-&gt;</span><span class="n">qdisc_sleeping</span> <span class="o">=</span> <span class="n">qdisc</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>创建noqueue</h2>

<p>开始尝试直接删除设备默认的pfifo_fast队列，发现会出错：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># tc qdisc del dev vethd4ea root</span>
</span><span class='line'>RTNETLINK answers: No such file or directory
</span><span class='line'><span class="c"># tc  -s qdisc ls dev vethd4ea</span>
</span><span class='line'>qdisc pfifo_fast 0: root refcnt <span class="m">2</span> bands <span class="m">3</span> priomap  <span class="m">1</span> <span class="m">2</span> <span class="m">2</span> <span class="m">2</span> <span class="m">1</span> <span class="m">2</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> 1
</span><span class='line'> Sent <span class="m">29705382</span> bytes <span class="m">441562</span> pkt <span class="o">(</span>dropped 0, overlimits <span class="m">0</span> requeues 0<span class="o">)</span>
</span><span class='line'> backlog 0b 0p requeues <span class="m">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>后来看到Jesper Brouer给出一个替换默认队列的方式，尝试了一下，成功完成。</p>

<p>替换默认的qdisc队列</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># tc qdisc replace dev vethd4ea root pfifo limit 100</span>
</span><span class='line'><span class="c"># tc  -s qdisc ls dev vethd4ea                      </span>
</span><span class='line'>qdisc pfifo 8001: root refcnt <span class="m">2</span> limit 100p
</span><span class='line'> Sent <span class="m">264</span> bytes <span class="m">4</span> pkt <span class="o">(</span>dropped 0, overlimits <span class="m">0</span> requeues 0<span class="o">)</span>
</span><span class='line'> backlog 0b 0p requeues <span class="m">0</span>
</span><span class='line'><span class="c"># ip link show vethd4ea</span>
</span><span class='line'>9: vethd4ea: &lt;BROADCAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc pfifo master docker0 state UP mode DEFAULT qlen 1000
</span><span class='line'>link/ether 3a:15:3b:e1:d7:6d brd ff:ff:ff:ff:ff:ff
</span></code></pre></td></tr></table></div></figure>


<p>修改队列长度</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># ifconfig vethd4ea txqueuelen 0</span>
</span></code></pre></td></tr></table></div></figure>


<p>删除qdisc</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># tc qdisc del dev vethd4ea root                    </span>
</span><span class='line'><span class="c"># ip link show vethd4ea                </span>
</span><span class='line'>9: vethd4ea: &lt;BROADCAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue master docker0 state UP mode DEFAULT
</span><span class='line'>link/ether 3a:15:3b:e1:d7:6d brd ff:ff:ff:ff:ff:ff
</span></code></pre></td></tr></table></div></figure>


<p>可以看到，UP的veth设备成功修改成noqueue。</p>

<h2>小结</h2>

<p>总之，给虚拟网络设备创建默认的qdisc，是不太合理的。这会让虚拟机（或者容器）的网络瓶颈过早的出现在qdisc，而不是真实的物理设备（除非应用需要创建qdisc）。更多详细参考<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1152231">这里</a>。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/05/14/octopressda-jian-jiao-cheng/">Octopress搭建教程</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/14/hello-octopress/">Hello Octopress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/03/kubernetes-services/">Kubernetes解析：services</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/31/veth/">从veth看虚拟网络设备的qdisc</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/feiji1hao">@feiji1hao</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'feiji1hao',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - 赵成辉 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
